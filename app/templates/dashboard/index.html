{% extends "base.html" %}

{% block title %}DockSafe - Dashboard{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        transition: transform 0.2s;
    }
    .stat-card:hover {
        transform: translateY(-2px);
    }
    .vulnerability-chart {
        height: 300px;
    }
    .scan-history-table {
        max-height: 400px;
        overflow-y: auto;
    }
    .status-badge {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }
    .refresh-btn {
        cursor: pointer;
    }
    .refresh-btn:hover {
        color: #007bff;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">
                <i class="fas fa-chart-line me-2"></i>Vulnerability Dashboard
            </h1>
            <div>
                <button class="btn btn-outline-primary refresh-btn" onclick="refreshDashboard()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
                <span class="text-muted ms-2" id="last-updated"></span>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card stat-card border-0 shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title text-muted mb-1">Total Scans</h6>
                        <h3 class="mb-0" id="total-scans">-</h3>
                    </div>
                    <div class="bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                        <i class="fas fa-search fa-lg text-primary"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card stat-card border-0 shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title text-muted mb-1">Success Rate</h6>
                        <h3 class="mb-0" id="success-rate">-</h3>
                    </div>
                    <div class="bg-success bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                        <i class="fas fa-check-circle fa-lg text-success"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card stat-card border-0 shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title text-muted mb-1">Critical Vulns</h6>
                        <h3 class="mb-0 text-danger" id="critical-vulns">-</h3>
                    </div>
                    <div class="bg-danger bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                        <i class="fas fa-exclamation-triangle fa-lg text-danger"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card stat-card border-0 shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title text-muted mb-1">High Vulns</h6>
                        <h3 class="mb-0 text-warning" id="high-vulns">-</h3>
                    </div>
                    <div class="bg-warning bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                        <i class="fas fa-exclamation-circle fa-lg text-warning"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row g-3 mb-4">
    <div class="col-md-8">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>Vulnerability Trends (Last 30 Days)
                </h5>
            </div>
            <div class="card-body">
                <canvas id="vulnerabilityChart" class="vulnerability-chart"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i class="fas fa-pie-chart me-2"></i>Severity Distribution
                </h5>
            </div>
            <div class="card-body">
                <canvas id="severityChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Recent Scans and Top Vulnerable Images -->
<div class="row g-3">
    <div class="col-md-8">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>Recent Scans
                </h5>
                <a href="{{ url_for('scanner.get_scan_history') }}" class="btn btn-sm btn-outline-primary">View All</a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive scan-history-table">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Image</th>
                                <th>Status</th>
                                <th>Vulnerabilities</th>
                                <th>Duration</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recent-scans">
                            <tr>
                                <td colspan="6" class="text-center text-muted py-4">
                                    <i class="fas fa-spinner fa-spin me-2"></i>Loading...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>Top Vulnerable Images
                </h5>
            </div>
            <div class="card-body">
                <div id="top-vulnerable-images">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-spinner fa-spin me-2"></i>Loading...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i class="fas fa-bolt me-2"></i>Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <button class="btn btn-outline-primary w-100" onclick="openScanModal()">
                            <i class="fas fa-search me-2"></i>Scan Image
                        </button>
                    </div>
                    <div class="col-md-3">
                        <a href="{{ url_for('reports.index') }}" class="btn btn-outline-success w-100">
                            <i class="fas fa-file-alt me-2"></i>Generate Report
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{{ url_for('notifications.index') }}" class="btn btn-outline-warning w-100">
                            <i class="fas fa-bell me-2"></i>Notifications
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{{ url_for('scanner.get_exceptions') }}" class="btn btn-outline-info w-100">
                            <i class="fas fa-cogs me-2"></i>Exceptions
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scan Modal -->
<div class="modal fade" id="scanModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-search me-2"></i>Scan Container Image
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="scanForm">
                    <div class="mb-3">
                        <label for="imageName" class="form-label">Image Name</label>
                        <input type="text" class="form-control" id="imageName" placeholder="e.g., nginx, ubuntu" required>
                    </div>
                    <div class="mb-3">
                        <label for="imageTag" class="form-label">Image Tag</label>
                        <input type="text" class="form-control" id="imageTag" placeholder="e.g., latest, 1.0.0" value="latest">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="startScan()">
                    <i class="fas fa-play me-2"></i>Start Scan
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let vulnerabilityChart, severityChart;

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
    initializeCharts();
    
    // Auto-refresh every 30 seconds
    setInterval(loadDashboardData, 30000);
});

function initializeCharts() {
    // Vulnerability trends chart
    const vulnCtx = document.getElementById('vulnerabilityChart').getContext('2d');
    vulnerabilityChart = new Chart(vulnCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Critical',
                data: [],
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                tension: 0.4
            }, {
                label: 'High',
                data: [],
                borderColor: '#fd7e14',
                backgroundColor: 'rgba(253, 126, 20, 0.1)',
                tension: 0.4
            }, {
                label: 'Medium',
                data: [],
                borderColor: '#ffc107',
                backgroundColor: 'rgba(255, 193, 7, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Severity distribution chart
    const severityCtx = document.getElementById('severityChart').getContext('2d');
    severityChart = new Chart(severityCtx, {
        type: 'doughnut',
        data: {
            labels: ['Critical', 'High', 'Medium', 'Low'],
            datasets: [{
                data: [0, 0, 0, 0],
                backgroundColor: [
                    '#dc3545',
                    '#fd7e14',
                    '#ffc107',
                    '#28a745'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                }
            }
        }
    });
}

async function loadDashboardData() {
    try {
        // Load statistics
        const statsResponse = await fetch('/dashboard/stats');
        const stats = await statsResponse.json();
        
        // Update statistics cards
        document.getElementById('total-scans').textContent = stats.total_scans;
        document.getElementById('success-rate').textContent = stats.success_rate.toFixed(1) + '%';
        document.getElementById('critical-vulns').textContent = stats.vulnerabilities.critical;
        document.getElementById('high-vulns').textContent = stats.vulnerabilities.high;
        
        // Update charts
        updateCharts(stats);
        
        // Load recent scans
        await loadRecentScans();
        
        // Load top vulnerable images
        await loadTopVulnerableImages();
        
        // Update last updated timestamp
        document.getElementById('last-updated').textContent = 'Last updated: ' + new Date().toLocaleTimeString();
        
    } catch (error) {
        console.error('Error loading dashboard data:', error);
        showAlert('Error loading dashboard data', 'danger');
    }
}

function updateCharts(stats) {
    // Update severity chart
    severityChart.data.datasets[0].data = [
        stats.vulnerabilities.critical,
        stats.vulnerabilities.high,
        stats.vulnerabilities.medium,
        stats.vulnerabilities.low
    ];
    severityChart.update();
    
    // For now, we'll use sample data for the trend chart
    // In a real implementation, you'd fetch historical data
    const sampleData = {
        labels: ['1 week ago', '6 days ago', '5 days ago', '4 days ago', '3 days ago', '2 days ago', 'Yesterday', 'Today'],
        critical: [2, 1, 3, 0, 1, 2, 1, stats.vulnerabilities.critical],
        high: [5, 4, 6, 3, 4, 5, 4, stats.vulnerabilities.high],
        medium: [8, 7, 9, 6, 7, 8, 7, stats.vulnerabilities.medium]
    };
    
    vulnerabilityChart.data.labels = sampleData.labels;
    vulnerabilityChart.data.datasets[0].data = sampleData.critical;
    vulnerabilityChart.data.datasets[1].data = sampleData.high;
    vulnerabilityChart.data.datasets[2].data = sampleData.medium;
    vulnerabilityChart.update();
}

async function loadRecentScans() {
    try {
        const response = await fetch('/scanner/history?limit=5');
        const data = await response.json();
        
        const tbody = document.getElementById('recent-scans');
        if (data.scans.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">No scans found</td></tr>';
            return;
        }
        
        tbody.innerHTML = data.scans.map(scan => `
            <tr>
                <td>
                    <strong>${scan.image_name}</strong>
                    <br><small class="text-muted">${scan.image_tag}</small>
                </td>
                <td>
                    <span class="badge status-badge ${getStatusClass(scan.scan_status)}">
                        ${scan.scan_status}
                    </span>
                </td>
                <td>
                    <span class="text-danger">${scan.critical_count}</span> /
                    <span class="text-warning">${scan.high_count}</span> /
                    <span class="text-info">${scan.medium_count}</span> /
                    <span class="text-success">${scan.low_count}</span>
                </td>
                <td>${scan.scan_duration_seconds}s</td>
                <td>${new Date(scan.created_at).toLocaleDateString()}</td>
                <td>
                    <a href="/scanner/scan/${scan.id}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-eye"></i>
                    </a>
                </td>
            </tr>
        `).join('');
        
    } catch (error) {
        console.error('Error loading recent scans:', error);
    }
}

async function loadTopVulnerableImages() {
    try {
        const response = await fetch('/scanner/statistics?days=30');
        const data = await response.json();
        
        const container = document.getElementById('top-vulnerable-images');
        if (data.top_vulnerable_images.length === 0) {
            container.innerHTML = '<div class="text-center text-muted py-4">No data available</div>';
            return;
        }
        
        container.innerHTML = data.top_vulnerable_images.map(([image, stats]) => `
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <strong>${image}</strong>
                    <br><small class="text-muted">${stats.scan_count} scans</small>
                </div>
                <div class="text-end">
                    <div class="text-danger">${stats.critical_vulns}</div>
                    <div class="text-warning">${stats.high_vulns}</div>
                </div>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Error loading top vulnerable images:', error);
    }
}

function getStatusClass(status) {
    switch (status) {
        case 'SUCCESS': return 'bg-success';
        case 'FAILED': return 'bg-danger';
        case 'IN_PROGRESS': return 'bg-warning';
        default: return 'bg-secondary';
    }
}

function refreshDashboard() {
    loadDashboardData();
}

function openScanModal() {
    const modal = new bootstrap.Modal(document.getElementById('scanModal'));
    modal.show();
}

async function startScan() {
    const imageName = document.getElementById('imageName').value;
    const imageTag = document.getElementById('imageTag').value;
    
    if (!imageName) {
        showAlert('Please enter an image name', 'warning');
        return;
    }
    
    try {
        const response = await fetch('/scanner/scan', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                image_name: imageName,
                image_tag: imageTag
            })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showAlert(`Scan started successfully! Scan ID: ${result.scan_id}`, 'success');
            bootstrap.Modal.getInstance(document.getElementById('scanModal')).hide();
            document.getElementById('scanForm').reset();
            
            // Refresh dashboard after a short delay
            setTimeout(loadDashboardData, 2000);
        } else {
            showAlert(`Scan failed: ${result.error}`, 'danger');
        }
        
    } catch (error) {
        console.error('Error starting scan:', error);
        showAlert('Error starting scan', 'danger');
    }
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.querySelector('main').insertBefore(alertDiv, document.querySelector('main').firstChild);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %}
