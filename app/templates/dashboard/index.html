{% extends "base.html" %}

{% block title %}DockSafe - Analytics Dashboard{% endblock %}
{% block page_title %}Analytics Dashboard{% endblock %}

{% block content %}
<!-- Dashboard Header -->
<div class="mb-8">
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Analytics Dashboard</h1>
            <p class="text-gray-600">Monitor your container security metrics and vulnerability trends</p>
        </div>
        <div class="flex gap-3">
            <button onclick="refreshDashboard()" class="btn btn-outline-primary">
                <i class="fas fa-sync-alt"></i>
                Refresh
            </button>
            <span class="text-sm text-gray-500 self-center" id="last-updated">
                Last updated: <span id="current-time"></span>
            </span>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-header">
            <h3 class="stat-title">Total Scans</h3>
            <div class="stat-icon primary">
                <i class="fas fa-search"></i>
            </div>
        </div>
        <p class="stat-value">{{ stats.total_scans or 0 }}</p>
        <div class="progress-bar">
            <div class="progress-fill" style="width: {% if (stats.total_scans or 0) > 0 %}100%{% else %}0%{% endif %}"></div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-header">
            <h3 class="stat-title">Success Rate</h3>
            <div class="stat-icon success">
                <i class="fas fa-check-circle"></i>
            </div>
        </div>
        <p class="stat-value">{{ stats.success_rate or 0 }}%</p>
        <div class="progress-bar">
            <div class="progress-fill" style="width: {{ stats.success_rate or 0 }}%"></div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-header">
            <h3 class="stat-title">Critical Issues</h3>
            <div class="stat-icon danger">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
        </div>
        <p class="stat-value">{{ stats.critical_issues or 0 }}</p>
        <div class="progress-bar">
            <div class="progress-fill" style="width: {% if (stats.critical_issues or 0) > 0 %}100%{% else %}0%{% endif %}"></div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-header">
            <h3 class="stat-title">High Severity</h3>
            <div class="stat-icon warning">
                <i class="fas fa-exclamation-circle"></i>
            </div>
        </div>
        <p class="stat-value">{{ stats.high_severity or 0 }}</p>
        <div class="progress-bar">
            <div class="progress-fill" style="width: {% if (stats.high_severity or 0) > 0 %}100%{% else %}0%{% endif %}"></div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-header">
            <h3 class="stat-title">Medium Severity</h3>
            <div class="stat-icon info">
                <i class="fas fa-info-circle"></i>
            </div>
        </div>
        <p class="stat-value">{{ stats.medium_severity or 0 }}</p>
        <div class="progress-bar">
            <div class="progress-fill" style="width: {% if (stats.medium_severity or 0) > 0 %}100%{% else %}0%{% endif %}"></div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-header">
            <h3 class="stat-title">Low Severity</h3>
            <div class="stat-icon success">
                <i class="fas fa-info"></i>
            </div>
        </div>
        <p class="stat-value">{{ stats.low_severity or 0 }}</p>
        <div class="progress-bar">
            <div class="progress-fill" style="width: {% if (stats.low_severity or 0) > 0 %}100%{% else %}0%{% endif %}"></div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
    <!-- Vulnerability Trends Chart -->
    <div class="card">
        <div class="card-header">
            <h2 class="text-xl font-semibold mb-0">
                <i class="fas fa-chart-line text-blue-600 mr-2"></i>
                Vulnerability Trends
            </h2>
            <p class="text-sm text-gray-500 mt-1">Real vulnerability trends from your scans</p>
        </div>
        <div class="card-body">
            <div class="chart-container" style="height: 300px;">
                <canvas id="vulnerabilityChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Severity Distribution Chart -->
    <div class="card">
        <div class="card-header">
            <h2 class="text-xl font-semibold mb-0">
                <i class="fas fa-chart-pie text-blue-600 mr-2"></i>
                Severity Distribution
            </h2>
            <p class="text-sm text-gray-500 mt-1">Current vulnerability breakdown</p>
        </div>
        <div class="card-body">
            <div class="chart-container" style="height: 300px;">
                <canvas id="severityChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Recent Scans Table -->
<div class="card">
    <div class="card-header">
        <h2 class="text-xl font-semibold mb-0">
            <i class="fas fa-history text-blue-600 mr-2"></i>
            Recent Scans
        </h2>
    </div>
    <div class="card-body p-0">
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>Image</th>
                        <th>Status</th>
                        <th>Vulnerabilities</th>
                        <th>Scan Time</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="recentScansTable">
                    {% if stats.total_scans and stats.total_scans > 0 %}
                        <tr>
                            <td colspan="5" class="text-center py-8">
                                <i class="fas fa-spinner fa-spin text-2xl text-gray-400 mb-2"></i>
                                <p class="text-gray-500">Loading recent scans...</p>
                            </td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="5" class="text-center py-8">
                                <i class="fas fa-search text-4xl text-gray-400 mb-4"></i>
                                <h3 class="text-lg font-medium text-gray-900 mb-2">No Scans Yet</h3>
                                <p class="text-gray-500 mb-4">Start by scanning your first container image</p>
                                <a href="{{ url_for('scanner.scanner_page') }}" class="btn btn-primary">
                                    <i class="fas fa-search"></i>
                                    Start Scanning
                                </a>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Chart configurations
let vulnerabilityChart, severityChart;

// Initialize charts
function initCharts() {
    // Vulnerability Trends Chart
    const vulnCtx = document.getElementById('vulnerabilityChart').getContext('2d');
    vulnerabilityChart = new Chart(vulnCtx, {
        type: 'line',
        data: {
            labels: ['1 week ago', '6 days ago', '5 days ago', '4 days ago', '3 days ago', '2 days ago', 'Yesterday', 'Today'],
            datasets: [
                {
                    label: 'Critical',
                    data: [0, 0, 0, 0, 0, 0, 0, {{ stats.critical_issues or 0 }}],
                    borderColor: '#dc2626',
                    backgroundColor: 'rgba(220, 38, 38, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'High',
                    data: [0, 0, 0, 0, 0, 0, 0, {{ stats.high_severity or 0 }}],
                    borderColor: '#d97706',
                    backgroundColor: 'rgba(217, 119, 6, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'Medium',
                    data: [0, 0, 0, 0, 0, 0, 0, {{ stats.medium_severity or 0 }}],
                    borderColor: '#0891b2',
                    backgroundColor: 'rgba(8, 145, 178, 0.1)',
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: '#f3f4f6'
                    }
                },
                x: {
                    grid: {
                        color: '#f3f4f6'
                    }
                }
            }
        }
    });

    // Severity Distribution Chart
    const sevCtx = document.getElementById('severityChart').getContext('2d');
    severityChart = new Chart(sevCtx, {
        type: 'doughnut',
        data: {
            labels: ['Critical', 'High', 'Medium', 'Low'],
            datasets: [{
                data: [
                    {{ stats.critical_issues or 0 }},
                    {{ stats.high_severity or 0 }},
                    {{ stats.medium_severity or 0 }},
                    {{ stats.low_severity or 0 }}
                ],
                backgroundColor: [
                    '#dc2626',
                    '#d97706',
                    '#0891b2',
                    '#16a34a'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                }
            }
        }
    });
}

// Fetch real historical data
function fetchChartData() {
    fetch('/dashboard/chart-data?days=7')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error fetching chart data:', data.error);
                return;
            }
            
            // Update vulnerability trends chart with real data
            vulnerabilityChart.data.labels = data.labels;
            vulnerabilityChart.data.datasets[0].data = data.critical;
            vulnerabilityChart.data.datasets[1].data = data.high;
            vulnerabilityChart.data.datasets[2].data = data.medium;
            vulnerabilityChart.update();
        })
        .catch(error => {
            console.error('Error fetching chart data:', error);
        });
}

// Load recent scans
function loadRecentScans() {
    fetch('/scanner/history?per_page=5')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error loading recent scans:', data.error);
                return;
            }
            
            const tbody = document.getElementById('recentScansTable');
            if (data.scans && data.scans.length > 0) {
                tbody.innerHTML = data.scans.map(scan => `
                    <tr>
                        <td>
                            <div class="font-medium text-gray-900">${scan.image_name}</div>
                            <div class="text-sm text-gray-500">${scan.image_tag}</div>
                        </td>
                        <td>
                            <span class="badge ${scan.scan_status === 'SUCCESS' ? 'bg-success' : 'bg-danger'}">
                                ${scan.scan_status}
                            </span>
                        </td>
                        <td>
                            <div class="text-sm">
                                <div class="flex gap-2">
                                    ${scan.critical_count > 0 ? `<span class="text-red-600 font-medium">${scan.critical_count} Critical</span>` : ''}
                                    ${scan.high_count > 0 ? `<span class="text-orange-600 font-medium">${scan.high_count} High</span>` : ''}
                                    ${scan.medium_count > 0 ? `<span class="text-blue-600 font-medium">${scan.medium_count} Medium</span>` : ''}
                                    ${scan.low_count > 0 ? `<span class="text-green-600 font-medium">${scan.low_count} Low</span>` : ''}
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="text-sm text-gray-900">${new Date(scan.scan_timestamp).toLocaleDateString()}</div>
                            <div class="text-xs text-gray-500">${new Date(scan.scan_timestamp).toLocaleTimeString()}</div>
                        </td>
                        <td>
                            <div class="flex gap-2">
                                <button onclick="viewScanDetails(${scan.id})" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                <button onclick="downloadReport(${scan.id})" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-download"></i> Download
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-8">
                            <i class="fas fa-search text-4xl text-gray-400 mb-4"></i>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">No Scans Yet</h3>
                            <p class="text-gray-500 mb-4">Start by scanning your first container image</p>
                            <a href="{{ url_for('scanner.scanner_page') }}" class="btn btn-primary">
                                <i class="fas fa-search"></i>
                                Start Scanning
                            </a>
                        </td>
                    </tr>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading recent scans:', error);
        });
}

// Global functions for scan actions
window.viewScanDetails = function(scanId) {
    window.open(`/reports/${scanId}/details`, '_blank');
};

window.downloadReport = function(scanId) {
    fetch(`/reports/${scanId}/download`)
        .then(response => {
            if (response.ok) {
                return response.blob();
            }
            throw new Error('Download failed');
        })
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `scan_report_${scanId}.json`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        })
        .catch(error => {
            console.error('Download error:', error);
            alert('Failed to download report');
        });
};

// Refresh dashboard
function refreshDashboard() {
    const refreshBtn = document.querySelector('button[onclick="refreshDashboard()"]');
    const originalText = refreshBtn.innerHTML;
    
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
    refreshBtn.disabled = true;
    
    // Update time
    document.getElementById('current-time').textContent = new Date().toLocaleTimeString();
    
    // Reload page to get fresh data
    setTimeout(() => {
        window.location.reload();
    }, 1000);
}

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    initCharts();
    fetchChartData();
    loadRecentScans();
    
    // Update last updated time
    document.getElementById('current-time').textContent = 
        new Date().toLocaleTimeString();
});
</script>
{% endblock %}