{% extends "base.html" %}

{% block title %}DockSafe - Vulnerability Scanner{% endblock %}
{% block page_title %}Vulnerability Scanner{% endblock %}

{% block content %}
<!-- Scanner Header -->
<div class="mb-8">
    <div class="card">
        <div class="card-body text-center py-8">
            <div class="mb-4">
                <i class="fas fa-search text-4xl text-blue-600 mb-4"></i>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Container Vulnerability Scanner</h1>
                <p class="text-lg text-gray-600 mb-4">
                    Scan your container images for security vulnerabilities
                </p>
                <p class="text-gray-500 max-w-2xl mx-auto">
                    Use industry-standard tools like Trivy to identify known vulnerabilities in your container images. 
                    Get detailed reports with severity levels and remediation guidance.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Scanner Form -->
<div class="mb-8">
    <div class="card">
        <div class="card-header">
            <h2 class="text-xl font-semibold mb-0">
                <i class="fas fa-cube text-blue-600 mr-2"></i>
                Scan Container Image
            </h2>
        </div>
        <div class="card-body">
            <form id="scanForm" class="space-y-6">
                <!-- Scanner Type Selection -->
                <div>
                    <label for="scannerType" class="form-label">
                        <i class="fas fa-cogs mr-2"></i>
                        Scanner Type
                    </label>
                    <select id="scannerType" name="scannerType" class="form-control" required>
                        <option value="trivy">Trivy (Recommended)</option>
                        <option value="clair">Clair (Requires Registry)</option>
                    </select>
                    <div class="text-sm text-gray-500 mt-1">
                        <strong>Trivy:</strong> Direct image scanning, works with local images<br>
                        <strong>Clair:</strong> Registry-based scanning, requires image to be pushed to a registry first
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="imageName" class="form-label">
                            <i class="fas fa-tag mr-2"></i>
                            Image Name
                        </label>
                        <input type="text" 
                               id="imageName" 
                               name="imageName" 
                               class="form-control" 
                               placeholder="e.g., nginx, ubuntu, node"
                               required>
                        <div class="text-sm text-gray-500 mt-1">
                            Enter the name of the container image to scan
                        </div>
                    </div>
                    
                    <div>
                        <label for="imageTag" class="form-label">
                            <i class="fas fa-tag mr-2"></i>
                            Image Tag
                        </label>
                        <input type="text" 
                               id="imageTag" 
                               name="imageTag" 
                               class="form-control" 
                               placeholder="latest"
                               value="latest">
                        <div class="text-sm text-gray-500 mt-1">
                            Specify the image tag (default: latest)
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-center">
                    <button type="submit" id="scanButton" class="btn btn-primary btn-lg">
                        <i class="fas fa-search mr-2"></i>
                        Start Scan
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Scan Results -->
<div id="scanResults" class="mb-8" style="display: none;">
    <div class="card">
        <div class="card-header">
            <h2 class="text-xl font-semibold mb-0">
                <i class="fas fa-clipboard-list text-blue-600 mr-2"></i>
                Scan Results
            </h2>
        </div>
        <div class="card-body">
            <div id="scanStatus" class="mb-4">
                <div class="flex items-center justify-center py-8">
                    <i class="fas fa-spinner fa-spin text-2xl text-blue-600 mr-3"></i>
                    <span class="text-lg font-medium text-gray-900">Scanning in progress...</span>
                </div>
            </div>
            
            <div id="scanDetails" style="display: none;">
                <!-- Scan details will be populated here -->
            </div>
        </div>
    </div>
</div>

<!-- Popular Images -->
<div class="mb-8">
    <div class="card">
        <div class="card-header">
            <h2 class="text-xl font-semibold mb-0">
                <i class="fas fa-star text-blue-600 mr-2"></i>
                Popular Images to Scan
            </h2>
        </div>
        <div class="card-body">
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                <button onclick="fillImageForm('nginx', 'latest')" class="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-center">
                    <i class="fas fa-server text-2xl text-green-600 mb-2"></i>
                    <div class="font-medium text-gray-900">nginx</div>
                    <div class="text-sm text-gray-500">Web Server</div>
                </button>
                
                <button onclick="fillImageForm('ubuntu', 'latest')" class="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-center">
                    <i class="fas fa-desktop text-2xl text-orange-600 mb-2"></i>
                    <div class="font-medium text-gray-900">ubuntu</div>
                    <div class="text-sm text-gray-500">OS</div>
                </button>
                
                <button onclick="fillImageForm('node', 'latest')" class="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-center">
                    <div class="w-8 h-8 mx-auto mb-2 bg-green-600 rounded flex items-center justify-center">
                        <span class="text-white font-bold text-sm">JS</span>
                    </div>
                    <div class="font-medium text-gray-900">node</div>
                    <div class="text-sm text-gray-500">Runtime</div>
                </button>
                
                <button onclick="fillImageForm('python', 'latest')" class="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-center">
                    <div class="w-8 h-8 mx-auto mb-2 bg-blue-600 rounded flex items-center justify-center">
                        <span class="text-white font-bold text-sm">Py</span>
                    </div>
                    <div class="font-medium text-gray-900">python</div>
                    <div class="text-sm text-gray-500">Runtime</div>
                </button>
                
                <button onclick="fillImageForm('postgres', 'latest')" class="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-center">
                    <i class="fas fa-database text-2xl text-blue-600 mb-2"></i>
                    <div class="font-medium text-gray-900">postgres</div>
                    <div class="text-sm text-gray-500">Database</div>
                </button>
                
                <button onclick="fillImageForm('redis', 'latest')" class="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-center">
                    <i class="fas fa-memory text-2xl text-red-600 mb-2"></i>
                    <div class="font-medium text-gray-900">redis</div>
                    <div class="text-sm text-gray-500">Cache</div>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Scanning Tips -->
<div class="mb-8">
    <div class="card">
        <div class="card-header">
            <h2 class="text-xl font-semibold mb-0">
                <i class="fas fa-lightbulb text-blue-600 mr-2"></i>
                Scanning Tips
            </h2>
        </div>
        <div class="card-body">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-3">
                        <i class="fas fa-check-circle text-green-600 mr-2"></i>
                        Best Practices
                    </h3>
                    <ul class="space-y-2 text-gray-600">
                        <li class="flex items-start">
                            <i class="fas fa-arrow-right text-blue-600 mr-2 mt-1 text-xs"></i>
                            Always specify image tags for reproducible scans
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-arrow-right text-blue-600 mr-2 mt-1 text-xs"></i>
                            Scan images regularly to catch new vulnerabilities
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-arrow-right text-blue-600 mr-2 mt-1 text-xs"></i>
                            Use specific versions instead of 'latest' in production
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-arrow-right text-blue-600 mr-2 mt-1 text-xs"></i>
                            Review and prioritize critical vulnerabilities first
                        </li>
                    </ul>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-3">
                        <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                        What Gets Scanned
                    </h3>
                    <ul class="space-y-2 text-gray-600">
                        <li class="flex items-start">
                            <i class="fas fa-arrow-right text-blue-600 mr-2 mt-1 text-xs"></i>
                            Operating system packages and libraries
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-arrow-right text-blue-600 mr-2 mt-1 text-xs"></i>
                            Application dependencies and frameworks
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-arrow-right text-blue-600 mr-2 mt-1 text-xs"></i>
                            Configuration files and secrets
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-arrow-right text-blue-600 mr-2 mt-1 text-xs"></i>
                            Known CVEs and security advisories
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Fill image form with popular image
function fillImageForm(imageName, imageTag) {
    document.getElementById('imageName').value = imageName;
    document.getElementById('imageTag').value = imageTag;
}

// Handle scan form submission
document.getElementById('scanForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const imageName = document.getElementById('imageName').value.trim();
    const imageTag = document.getElementById('imageTag').value.trim() || 'latest';
    const scannerType = document.getElementById('scannerType').value;
    const scanButton = document.getElementById('scanButton');
    const scanResults = document.getElementById('scanResults');
    const scanStatus = document.getElementById('scanStatus');
    
    if (!imageName) {
        alert('Please enter an image name');
        return;
    }
    
    // Show loading state
    scanButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Scanning...';
    scanButton.disabled = true;
    scanResults.style.display = 'block';
    
    // Show scanning status
    scanStatus.innerHTML = `
        <div class="flex items-center justify-center py-8">
            <i class="fas fa-spinner fa-spin text-2xl text-blue-600 mr-3"></i>
            <span class="text-lg font-medium text-gray-900">Scanning ${imageName}:${imageTag}...</span>
        </div>
        <div class="text-center text-gray-500">
            This may take a few minutes depending on the image size
        </div>
    `;
    
    // Start scan
    fetch('/scanner/scan', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            image_name: imageName,
            image_tag: imageTag,
            scanner_type: scannerType
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }
        
        // Show scan started message
        scanStatus.innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-check-circle text-2xl text-green-600 mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-2">Scan Started Successfully</h3>
                <p class="text-gray-500 mb-4">Scan ID: ${data.id}</p>
                <p class="text-gray-500">The scan is running in the background. You can check the results in the Reports section.</p>
            </div>
        `;
        
        // Reset form
        document.getElementById('scanForm').reset();
        document.getElementById('imageTag').value = 'latest';
        
    })
    .catch(error => {
        console.error('Scan error:', error);
        scanStatus.innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-exclamation-triangle text-2xl text-red-600 mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-2">Scan Failed</h3>
                <p class="text-gray-500 mb-4">${error.message}</p>
                <button onclick="document.getElementById('scanResults').style.display='none'" class="btn btn-primary">
                    Try Again
                </button>
            </div>
        `;
    })
    .finally(() => {
        // Reset button
        scanButton.innerHTML = '<i class="fas fa-search mr-2"></i>Start Scan';
        scanButton.disabled = false;
    });
});

// Auto-focus on image name input
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('imageName').focus();
});
</script>
{% endblock %}